<div class="employee-tasks">
  <div *ngIf="isLoading" class="loading-state">
    <mat-spinner diameter="56"></mat-spinner>
    <p>Preparando tus tareas asignadas...</p>
  </div>

  <div *ngIf="!isLoading && errorMessage" class="error-state">
    <mat-icon>error</mat-icon>
    <h2>Ocurrió un error</h2>
    <p>{{ errorMessage }}</p>
  </div>

  <ng-container *ngIf="!isLoading && !errorMessage">
    <mat-card class="filters-card" *ngIf="filters.length > 1">
      <mat-card-header>
        <mat-card-title>Filtrar por estado</mat-card-title>
        <mat-card-subtitle>Selecciona el estado que deseas revisar</mat-card-subtitle>
      </mat-card-header>
      <mat-divider></mat-divider>
      <mat-button-toggle-group
        [value]="selectedFilter"
        (change)="applyFilter($event.value)"
        class="filters-toggle"
        exclusive
      >
        <mat-button-toggle *ngFor="let filter of filters" [value]="filter.value">
          {{ filter.label }}
        </mat-button-toggle>
      </mat-button-toggle-group>
    </mat-card>

    <mat-card class="tasks-card" *ngIf="filteredTasks.length > 0; else noTasks">
      <mat-card-header>
        <mat-card-title>Detalle de tareas</mat-card-title>
        <mat-card-subtitle>Revisa la información clave de cada pedido asignado</mat-card-subtitle>
      </mat-card-header>
      <mat-divider></mat-divider>
      <div class="table-wrapper">
        <table mat-table [dataSource]="filteredTasks" class="tasks-table">
          <ng-container matColumnDef="sequence">
            <th mat-header-cell *matHeaderCellDef>#</th>
            <td mat-cell *matCellDef="let task; let i = index">{{ task.sequence || i + 1 }}</td>
          </ng-container>

          <ng-container matColumnDef="product">
            <th mat-header-cell *matHeaderCellDef>Producto</th>
            <td mat-cell *matCellDef="let task">
              <div class="cell-with-icon">
                <mat-icon>style</mat-icon>
                <div>
                  <span class="primary-text">{{ task.product?.name || 'Producto por asignar' }}</span>
                  <span class="secondary-text" *ngIf="task.product?.category_name">
                    {{ task.product?.category_name }}
                  </span>
                </div>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="area">
            <th mat-header-cell *matHeaderCellDef>Área</th>
            <td mat-cell *matCellDef="let task">{{ task.area?.name || 'Sin área' }}</td>
          </ng-container>

          <ng-container matColumnDef="state">
            <th mat-header-cell *matHeaderCellDef>Estado</th>
            <td mat-cell *matCellDef="let task">
              <mat-chip [ngClass]="getStateClass(task)" matTooltip="{{ task.state?.name || 'Sin estado' }}">
                {{ task.state?.name || 'Sin estado' }}
              </mat-chip>
            </td>
          </ng-container>

          <ng-container matColumnDef="start">
            <th mat-header-cell *matHeaderCellDef>Inicio</th>
            <td mat-cell *matCellDef="let task">
              <ng-container *ngIf="task.start_date; else startPlaceholder">
                {{ task.start_date | date: 'dd/MM/yyyy HH:mm' }}
              </ng-container>
              <ng-template #startPlaceholder>Sin iniciar</ng-template>
            </td>
          </ng-container>

          <ng-container matColumnDef="end">
            <th mat-header-cell *matHeaderCellDef>Fin</th>
            <td mat-cell *matCellDef="let task">
              <ng-container *ngIf="task.end_date; else endPlaceholder">
                {{ task.end_date | date: 'dd/MM/yyyy HH:mm' }}
              </ng-container>
              <ng-template #endPlaceholder>En curso</ng-template>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="actions-column">Acciones</th>
            <td mat-cell *matCellDef="let task">
              <div class="actions-cell">
                <button
                  mat-stroked-button
                  color="primary"
                  type="button"
                  *ngIf="!task.start_date"
                  (click)="markTaskAsInProgress(task)"
                  [disabled]="isActionLoading(task.id_task)"
                >
                  <mat-icon *ngIf="!isActionLoading(task.id_task)">play_arrow</mat-icon>
                  <mat-progress-spinner
                    *ngIf="isActionLoading(task.id_task)"
                    mode="indeterminate"
                    diameter="18"
                  ></mat-progress-spinner>
                  <span>Iniciar</span>
                </button>

                <button
                  mat-flat-button
                  color="accent"
                  type="button"
                  *ngIf="task.start_date && !task.end_date"
                  (click)="markTaskAsCompleted(task)"
                  [disabled]="isActionLoading(task.id_task)"
                >
                  <mat-icon *ngIf="!isActionLoading(task.id_task)">task_alt</mat-icon>
                  <mat-progress-spinner
                    *ngIf="isActionLoading(task.id_task)"
                    mode="indeterminate"
                    diameter="18"
                  ></mat-progress-spinner>
                  <span>Finalizar</span>
                </button>

                <span class="completed-label" *ngIf="task.end_date">
                  <mat-icon>check_circle</mat-icon>
                  Finalizada
                </span>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackTask"></tr>
        </table>
      </div>
    </mat-card>

    <ng-template #noTasks>
      <div class="empty-state">
        <mat-icon>sentiment_satisfied</mat-icon>
        <h3>No hay tareas en este estado</h3>
        <p>Selecciona otro filtro o regresa más tarde para revisar nuevas asignaciones.</p>
      </div>
    </ng-template>
  </ng-container>
</div>
